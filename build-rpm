#!/bin/bash
set -ETeu -o pipefail

printHelp() {
	echo "usage: ${0} <name> <workspace>"
	exit 1
}

if [[ "${1}" == "" || "${2}" == "" ]]; then
	printHelp
fi

name="${1}"
buildroot="${2}"

build_number=$(git rev-list HEAD | wc -l)

rpmbuild --verbose \
		 -ba ${WORKSPACE}/libvmod-maxmind-geoip.spec \
		 --define "_version_number 4.1.0" \
		 --define "_build_number ${build_number}" \
		 --define "_source ${buildroot}"

rpm=$(find ${buildroot}/rpmbuild -name ${name}*.rpm)
rpmfile=$(echo ${rpm}|sed 's|.*/||')

echo "BUILD=${buildnumber}" > ${WORKSPACE}/version.properties
echo "VERSION=${version}-${buildnumber}" >> ${WORKSPACE}/version.properties
echo "RPM=$rpmfile" >> ${WORKSPACE}/version.properties
echo $rpm
exit 0
